<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi aplikÃ¡cia â€“ iPhone verzia</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.5/dist/leaflet.css"/>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:12px;
}
h1 { text-align:center; }
.card {
  background:white;
  padding:14px;
  border-radius:12px;
  margin-bottom:14px;
}
label {
  font-weight:600;
  display:block;
  margin-top:10px;
}
input, select, button {
  width:100%;
  padding:12px;
  font-size:16px;
  margin-top:6px;
}
button {
  background:#007aff;
  color:white;
  border:none;
  border-radius:10px;
}
button:active { opacity:0.85; }

#map {
  height:320px;
  border-radius:12px;
  margin-top:10px;
}

.result {
  font-size:18px;
  font-weight:bold;
}
.green { color:green; }
.red { color:red; }
</style>
</head>

<body>

<h1>ğŸš• Taxi aplikÃ¡cia</h1>

<div class="card">
  <label>ReÅ¾im</label>
  <select id="mode">
    <option value="costs">KalkulaÄka nÃ¡kladov</option>
    <option value="taximeter">Taxameter</option>
  </select>
</div>

<div class="card">
  <label>Poloha vozidla</label>
  <input id="vehiclePos" readonly placeholder="GPS eÅ¡te nenaÄÃ­tanÃ©">

  <button onclick="loadGPS()">ğŸ“ NaÄÃ­taÅ¥ polohu vozidla</button>

  <label>NÃ¡stup klienta</label>
  <input id="startAddress" placeholder="Klikni na mapu">

  <label>CieÄ¾ klienta</label>
  <input id="endAddress" placeholder="Klikni na mapu">

  <label>PrÃ­platky</label>
  <input type="number" id="extras" value="0" step="0.1">
</div>

<div id="map"></div>

<div id="results" class="card result">
  ÄŒakÃ¡m na Ãºdajeâ€¦
</div>

<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"></script>

<script>
/* ===== MAPA ===== */
const map = L.map("map").setView([48.1486, 17.1077], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

let vehicleMarker, startMarker, endMarker, routeLine;

/* ===== GPS â€“ iba po kliknutÃ­ ===== */
function loadGPS() {
  if (!navigator.geolocation) {
    alert("GPS nie je podporovanÃ©");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      document.getElementById("vehiclePos").value =
        lat.toFixed(6) + "," + lon.toFixed(6);

      if (!vehicleMarker) {
        vehicleMarker = L.marker([lat, lon], { draggable:true })
          .addTo(map)
          .bindPopup("Vozidlo");
        vehicleMarker.on("dragend", calculate);
      } else {
        vehicleMarker.setLatLng([lat, lon]);
      }

      map.setView([lat, lon], 15);
      calculate();
    },
    err => alert("GPS chyba: " + err.message),
    { enableHighAccuracy:true }
  );
}

/* ===== Kliky na mapu ===== */
map.on("click", e => {
  const lat = e.latlng.lat;
  const lon = e.latlng.lng;

  if (!startMarker) {
    startMarker = L.marker([lat, lon], { draggable:true })
      .addTo(map)
      .bindPopup("NÃ¡stup");
    startMarker.on("dragend", calculate);
    startAddress.value = lat.toFixed(6)+","+lon.toFixed(6);
  } else if (!endMarker) {
    endMarker = L.marker([lat, lon], { draggable:true })
      .addTo(map)
      .bindPopup("CieÄ¾");
    endMarker.on("dragend", calculate);
    endAddress.value = lat.toFixed(6)+","+lon.toFixed(6);
  }
  calculate();
});

/* ===== OSRM ===== */
async function distance(lat1, lon1, lat2, lon2) {
  const url =
    `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false`;
  const r = await fetch(url);
  const d = await r.json();
  return d.routes[0].distance / 1000;
}

/* ===== VÃPOÄŒET ===== */
async function calculate() {
  if (!vehicleMarker || !startMarker || !endMarker) return;

  const v = vehicleMarker.getLatLng();
  const s = startMarker.getLatLng();
  const e = endMarker.getLatLng();
  const extras = +extrasInput.value || 0;

  const km1 = await distance(v.lat,v.lng,s.lat,s.lng);
  const km2 = await distance(s.lat,s.lng,e.lat,e.lng);

  const price = km1*0.31 + km2*0.85 + extras;
  const prov = price*0.25;
  const dph = prov*0.23;
  const profit = price - (prov+dph);

  results.innerText =
    `Cena/NÃ¡klady: ${price.toFixed(2)} â‚¬ | Zisk: ${profit.toFixed(2)} â‚¬`;
  results.className = "card result " + (profit>=0?"green":"red");

  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline([[v.lat,v.lng],[s.lat,s.lng],[e.lat,e.lng]],{color:"blue"})
    .addTo(map);
}

const extrasInput = document.getElementById("extras");
const startAddress = document.getElementById("startAddress");
const endAddress = document.getElementById("endAddress");
const results = document.getElementById("results");
</script>

</body>
</html>
